global
  log 127.0.0.1 local0 notice
  maxconn 8192
  user haproxy
  group haproxy

defaults
  log global
  mode http
  option dontlognull
  option redispatch
  option forwardfor
  option httplog
  option http-server-close
  maxconn <%= node.scpr_consul_haproxy.max_sessions %>
  timeout client <%= node.scpr_consul_haproxy.timeout_client %>
  timeout server <%= node.scpr_consul_haproxy.timeout_server %>
  timeout connect <%= node.scpr_consul_haproxy.timeout_connect %>
  retries 3

{{with $config := key "<%= @config_key %>" | parseJSON}}
frontend http-in
  bind *:80
  {{range $config.services}}
  acl sv_{{.service}} hdr(host) -i {{.hostname}}{{end}}
  {{range $config.services}}
  use_backend {{.service}} if sv_{{.service}}{{end}}

{{range $config.services}}
backend {{.service}}
  balance leastconn{{range service .service}}
  server {{.Node}} {{.Address}}:80{{end}}
{{end}}{{end}}

listen stats <%= @admin_ip %>:1944
  mode http
  stats enable
  stats uri /