global
  log 127.0.0.1 local0 notice
  maxconn 4096
  user haproxy
  group haproxy

defaults
  log global
  mode http
  option http-tunnel
  option dontlognull
  option redispatch
  option forwardfor
  option httplog
  maxconn <%= node.scpr_consul_haproxy.max_sessions %>
  timeout client <%= node.scpr_consul_haproxy.timeout_client %>
  timeout server <%= node.scpr_consul_haproxy.timeout_server %>
  timeout connect <%= node.scpr_consul_haproxy.timeout_connect %>
  timeout tunnel 1m
  retries 3

frontend listeners-in
  bind *:80
  default_backend listeners

frontend sources-in
  bind *:8021
  mode tcp
  default_backend sources

backend listeners
  balance leastconn{{range service "streammachine_<%= @config_key %>_<%= node.scpr_consul_haproxy.streammachine_svc_listener %>"}}
  server {{.Node}} {{.Address}}:8020{{end}}

backend sources{{with $s := service "streammachine_<%= @config_key %>_<%= node.scpr_consul_haproxy.streammachine_svc_source %>"}}{{with index $s 0}}
  balance leastconn
  mode tcp
  retries 0
  no option redispatch
  server {{.Node}} {{.Address}}:8021{{end}}{{end}}

listen stats <%= @admin_ip %>:1944
  mode http
  stats enable
  stats uri /